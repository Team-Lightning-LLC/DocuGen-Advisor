<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DocuGen Finance</title>
<!-- Add marked.js library for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
:root {
  --primary: #336F51;
  --primary-light: #4a8a6a;
  --primary-dark: #2a5a43;
  --ink: #1f2d3d;
  --muted: #6c7a89;
  --border: #e0e5ea;
  --hair: #eceff3;
  --bg: #f5f6f7;
  --card: #fff;
  --soft: #f8f9fb;
  --ok: #1f7a4d;
  --warn: #8a5a00;
  --info: #2d5699;
  --shadow: 0 6px 18px rgba(20,26,38,.08);
  --success: #28a745;
  --error: #dc3545;
}

* { 
  margin: 0; 
  padding: 0; 
  box-sizing: border-box; 
}

html, body {
  height: 100vh;
  overflow: hidden; /* Prevent page scrolling */
}

body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu, Cantarell, sans-serif;
  font-size: 14px; 
  background: var(--bg); 
  color: var(--ink);
  line-height: 1.5;
}

/* Header */
.header {
  background: #fff;
  padding: 0 32px;
  height: 72px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  box-shadow: var(--shadow);
}

.logo-section {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 800;
  font-size: 18px;
}

.brand-info h1 {
  font-size: 24px;
  font-weight: 700;
  color: var(--ink);
  line-height: 1.2;
}

.brand-info .subtitle {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

.header-title {
  font-size: 28px;
  font-weight: 300;
  color: var(--primary);
  letter-spacing: -0.5px;
}

/* Secondary Navigation */
.secondary-nav {
  background: #fff;
  border-bottom: 1px solid var(--border);
  padding: 0 32px;
  position: fixed;
  top: 72px;
  left: 0;
  right: 0;
  z-index: 999;
  height: 48px;
  display: flex;
  align-items: center;
}

.secondary-links {
  display: flex;
  gap: 32px;
}

.secondary-link {
  padding: 8px 16px;
  font-size: 14px;
  font-weight: 500;
  color: var(--muted);
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s ease;
  position: relative;
}

.secondary-link:hover {
  color: var(--ink);
  background: var(--soft);
}

.secondary-link.active {
  color: var(--primary);
  font-weight: 600;
}

.secondary-link.active::after {
  content: '';
  position: absolute;
  bottom: -20px;
  left: 50%;
  transform: translateX(-50%);
  width: 24px;
  height: 2px;
  background: var(--primary);
  border-radius: 1px;
}

/* Advisor Banner */
.advisor-banner {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  color: #fff;
  padding: 24px 32px;
  margin-top: 120px;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  overflow: hidden;
}

.advisor-banner::after {
  content: '';
  position: absolute;
  right: -80px;
  top: -40px;
  width: 200px;
  height: 200px;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
}

.advisor-banner h2 {
  font-size: 20px;
  font-weight: 500;
  position: relative;
  z-index: 2;
}

/* Main Layout - FIXED */
.main-layout {
  display: grid;
  grid-template-columns: 280px 1fr 320px;
  gap: 24px;
  padding: 24px 32px;
  max-width: 1600px;
  margin: 0 auto;
  height: calc(100vh - 144px); /* Constrain total height */
  grid-template-rows: minmax(0, 1fr); /* CRITICAL: Allow grid items to shrink */
}

/* Column Base - FIXED */
.column {
  background: var(--card);
  border: 1px solid var(--hair);
  border-radius: 16px;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  height: 100%; /* CRITICAL: Take full grid cell height */
  max-height: 100%; /* CRITICAL: Don't exceed grid cell height */
}

.column-header {
  background: var(--soft);
  padding: 20px 24px;
  border-bottom: 1px solid var(--hair);
  font-weight: 700;
  font-size: 16px;
  color: var(--ink);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0; /* Prevent header from shrinking */
}

/* Column Body - FIXED */
.column-body {
  flex: 1;
  padding: 20px 24px;
  overflow-y: auto;
  overflow-x: hidden;
  min-height: 0; /* CRITICAL: Allow flex item to shrink below content size */
}

/* Scrollbar styling */
.column-body::-webkit-scrollbar {
  width: 8px;
}

.column-body::-webkit-scrollbar-track {
  background: var(--soft);
  border-radius: 4px;
}

.column-body::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
}

.column-body::-webkit-scrollbar-thumb:hover {
  background: var(--muted);
}

/* Firefox scrollbar */
.column-body {
  scrollbar-width: thin;
  scrollbar-color: var(--border) var(--soft);
}

/* Clients Column - REMOVED sticky positioning */
.clients-column {
  /* Remove: position: sticky; top: 120px; */
}

.client-header-actions {
  display: flex;
  gap: 8px;
}

.icon-btn {
  width: 32px;
  height: 32px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.refresh-clients-btn {
  background: var(--info);
  color: white;
}

.refresh-clients-btn:hover {
  background: #1e4a7a;
  transform: rotate(180deg);
}

.add-client-btn {
  background: var(--primary);
  color: white;
}

.add-client-btn:hover {
  background: var(--primary-dark);
  transform: scale(1.05);
}

.client-item {
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-weight: 500;
  border: 1px solid transparent;
}

.client-item:hover {
  background: rgba(51, 111, 81, 0.05);
  border-color: rgba(51, 111, 81, 0.1);
}

.client-item.active {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  color: white;
  font-weight: 600;
  border-color: var(--primary);
  box-shadow: 0 4px 12px rgba(51, 111, 81, 0.25);
}

.empty-state {
  text-align: center;
  color: var(--muted);
  font-style: italic;
  padding: 40px 20px;
  background: var(--soft);
  border-radius: 12px;
  border: 1px dashed var(--border);
}

/* Documents Column - REMOVED min-height */
.documents-column {
  /* Remove: min-height: 600px; */
}

.upload-area {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 32px 24px;
  text-align: center;
  margin-bottom: 24px;
  background: var(--soft);
  position: relative;
  transition: all 0.3s ease;
}

.upload-area:hover {
  border-color: var(--primary);
  background: rgba(51, 111, 81, 0.02);
}

.upload-input {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}

.upload-text {
  color: var(--muted);
  font-size: 15px;
  font-weight: 500;
}

/* AI Profile Status */

.profile-status-inline {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  font-weight: 500;
}

.profile-complete-inline {
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--ok);
  font-weight: 600;
}

.profile-needed-inline {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--warn);
  font-weight: 500;
}

.status-light-inline {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-light-inline.green {
  background: var(--ok);
  box-shadow: 0 0 0 2px rgba(31, 122, 77, 0.2);
}

.status-light-inline.red {
  background: var(--warn);
  box-shadow: 0 0 0 2px rgba(138, 90, 0, 0.2);
}

.generate-profile-btn-inline {
  background: var(--primary);
  color: white;
  border: none;
  padding: 4px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
  transition: all 0.2s ease;
  margin-left: 4px;
}

.generate-profile-btn-inline:hover:not(:disabled) {
  background: var(--primary-dark);
}

.generate-profile-btn-inline:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Document Controls */
.doc-controls {
  display: flex;
  gap: 16px;
  margin-bottom: 20px;
  align-items: center;
}

.search-bar {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
  background: white;
  transition: all 0.2s ease;
}

.search-bar:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(51, 111, 81, 0.1);
}

.doc-control {
  color: var(--primary);
  text-decoration: none;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.doc-control:hover {
  background: rgba(51, 111, 81, 0.1);
  color: var(--primary-dark);
}

/* Document List */
.doc-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 0;
  border-bottom: 1px solid var(--hair);
  transition: all 0.2s ease;
}

.doc-item:hover {
  background: var(--soft);
  margin: 0 -24px;
  padding-left: 24px;
  padding-right: 24px;
  border-radius: 8px;
}

.doc-item:last-child {
  border-bottom: none;
}

.doc-info {
  flex: 1;
}

.doc-name {
  font-weight: 600;
  color: var(--ink);
  margin-bottom: 4px;
  font-size: 14px;
}

.doc-date {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

.doc-actions {
  display: flex;
  gap: 12px;
  font-size: 12px;
}

.doc-action {
  color: var(--primary);
  text-decoration: none;
  cursor: pointer;
  font-weight: 600;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.doc-action:hover {
  background: rgba(51, 111, 81, 0.1);
  color: var(--primary-dark);
}

/* Generate Column - REMOVED sticky positioning */
.generate-column {
  /* Remove: position: sticky; top: 120px; */
}

.generator-form {
  margin-bottom: 32px;
}

.generator-select {
  width: 100%;
  padding: 14px 16px;
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
  margin-bottom: 16px;
  background: white;
  transition: all 0.2s ease;
}

.generator-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(51, 111, 81, 0.1);
}

.generator-btn {
  width: 100%;
  padding: 14px 20px;
  border: 1px solid var(--primary);
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s ease;
  margin-bottom: 12px;
  background: var(--primary);
  color: white;
}

.generator-btn:hover:not(:disabled) {
  background: var(--primary-dark);
  border-color: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(51, 111, 81, 0.25);
}

.test-btn {
  background: var(--info);
  border-color: var(--info);
}

.test-btn:hover:not(:disabled) {
  background: #1e4a7a;
  border-color: #1e4a7a;
}

.generator-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

/* Queue Section */
.queue-section {
  border-top: 1px solid var(--hair);
  padding-top: 24px;
}

.queue-header {
  font-weight: 700;
  font-size: 15px;
  color: var(--ink);
  margin-bottom: 16px;
}

.queue-item {
  background: var(--soft);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.spinner {
  width: 16px;
  height: 16px;
  border: 2px solid var(--border);
  border-left-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.queue-item-content {
  flex: 1;
  font-size: 13px;
}

.queue-item-name {
  font-weight: 600;
  color: var(--ink);
  margin-bottom: 4px;
}

.queue-item-client {
  color: var(--muted);
  font-size: 12px;
}

.queue-timer {
  font-size: 12px;
  color: var(--info);
  font-weight: 600;
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
}

.queue-cancel {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  font-size: 14px;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.queue-cancel:hover {
  background: rgba(220, 53, 69, 0.1);
  color: var(--error);
}

/* Document Viewer */
dialog#viewer {
  width: min(1200px, 95vw);
  height: min(90vh, 900px);
  border: 0;
  border-radius: 16px;
  padding: 0;
  overflow: hidden;
  box-shadow: 0 25px 80px rgba(0,0,0,.35);
  margin: auto;
}

dialog::backdrop {
  background: rgba(0,0,0,.6);
}

.viewer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--ink);
  color: #fff;
  padding: 16px 24px;
}

.viewer-title {
  font-weight: 600;
  font-size: 16px;
}

.close-btn {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: white;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.close-btn:hover {
  background: rgba(255,255,255,0.15);
}

#viewerFrame {
  width: 100%;
  height: calc(100% - 64px);
  border: 0;
  background: #f5f6f7;
}

/* Document viewer content styling */
.viewer-content {
  padding: 40px 50px;
  max-width: 1000px;
  margin: 0 auto;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  line-height: 1.6;
  color: #1f2d3d;
  background: white;
  height: calc(100% - 64px);
  overflow-y: auto;
}

.viewer-content h1 {
  font-size: 32px;
  color: var(--primary);
  border-bottom: 3px solid var(--primary);
  padding-bottom: 16px;
  margin: 40px 0 24px 0;
  font-weight: 700;
}

.viewer-content h2 {
  font-size: 24px;
  color: #1f2d3d;
  margin: 32px 0 16px 0;
  font-weight: 600;
  border-left: 4px solid var(--primary);
  padding-left: 16px;
}

.viewer-content h3 {
  font-size: 20px;
  color: #1f2d3d;
  margin: 24px 0 14px 0;
  font-weight: 600;
}

.viewer-content h4 {
  font-size: 18px;
  color: #1f2d3d;
  margin: 20px 0 12px 0;
  font-weight: 600;
}

.viewer-content p {
  margin-bottom: 18px;
  text-align: justify;
}

.viewer-content ul, .viewer-content ol {
  margin: 18px 0;
  padding-left: 32px;
}

.viewer-content li {
  margin-bottom: 10px;
}

.viewer-content strong {
  color: var(--primary);
  font-weight: 600;
}

.viewer-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 24px 0;
  font-size: 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-radius: 8px;
  overflow: hidden;
}

.viewer-content table th {
  background: var(--soft);
  border: 1px solid var(--border);
  padding: 14px 12px;
  text-align: left;
  font-weight: 600;
  color: var(--ink);
}

.viewer-content table td {
  border: 1px solid var(--border);
  padding: 12px;
  text-align: left;
}

.viewer-content table tr:nth-child(even) {
  background: #fafbfc;
}

.viewer-content blockquote {
  border-left: 4px solid var(--primary);
  margin: 20px 0;
  padding: 10px 20px;
  background-color: var(--soft);
  font-style: italic;
}

.viewer-content code {
  background-color: #f5f6f7;
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
}

.viewer-content pre {
  background-color: #f5f6f7;
  padding: 15px;
  border-radius: 6px;
  overflow-x: auto;
  margin: 20px 0;
}

.viewer-content hr {
  border: none;
  border-top: 2px solid #e0e5ea;
  margin: 30px 0;
}

/* Improved Delete Modal Styling */
#deleteModal {
  width: min(480px, 90vw);
  border: 0;
  border-radius: 12px;
  padding: 0;
  box-shadow: 0 20px 60px rgba(0,0,0,.25);
  margin: auto;
}

.delete-modal-content {
  background: white;
  border-radius: 12px;
  overflow: hidden;
}

.delete-modal-header {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: white;
  padding: 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  border-radius: 11px 11px 0 0; /* Add this line */
}

.delete-modal-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.delete-modal-header h3::before {
  content: '';
  font-size: 20px;
}

.delete-modal-body {
  padding: 24px;
  background: #fafafa;
}

.delete-warning {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 1px solid #f59e0b;
  border-radius: 8px;
  padding: 16px 20px;
  margin-bottom: 20px;
  color: #92400e;
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 500;
  box-shadow: 0 2px 4px rgba(245, 158, 11, 0.1);
}

.delete-warning::before {
  content: '';
  font-size: 18px;
  flex-shrink: 0;
}

.delete-modal-body p {
  margin-bottom: 20px;
  line-height: 1.6;
  color: #374151;
  font-size: 14px;
}

.document-info {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 24px;
  font-size: 14px;
  color: #374151;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.document-info strong {
  color: #111827;
  font-weight: 600;
}

.delete-confirmation {
  margin-bottom: 24px;
}

.checkbox-container {
  display: flex;
  align-items: flex-start;
  cursor: pointer;
  font-size: 14px;
  line-height: 1.5;
  gap: 12px;
  padding: 16px;
  background: white;
  border-radius: 8px;
  border: 2px solid #e5e7eb;
  transition: all 0.2s ease;
}

.checkbox-container:hover {
  border-color: #ef4444;
  background: #fef2f2;
}

.checkmark {
  width: 20px;
  height: 20px;
  background-color: white;
  border: 2px solid #d1d5db;
  border-radius: 4px;
  position: relative;
  flex-shrink: 0;
  margin-top: 2px;
  transition: all 0.2s ease;
}

.checkbox-container:hover .checkmark {
  border-color: #ef4444;
}

.checkbox-container input:checked + .checkmark {
  background-color: #ef4444;
  border-color: #ef4444;
}

.checkbox-container input:checked + .checkmark::after {
  content: '';
  position: absolute;
  left: 6px;
  top: 2px;
  width: 5px;
  height: 10px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

.delete-modal-actions {
  background: #f9fafb;
  padding: 20px 24px;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  border-top: 1px solid #e5e7eb;
}

.delete-modal-actions .btn {
  min-width: 100px;
  font-weight: 600;
}

.btn-secondary {
  background: white;
  color: #374151;
  border: 1px solid #d1d5db;
}

.btn-secondary:hover:not(:disabled) {
  background: #f9fafb;
  border-color: #9ca3af;
}

.btn-danger {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: white;
  border: 1px solid #dc2626;
  box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
}

.btn-danger:hover:not(:disabled) {
  background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  border-color: #b91c1c;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
}

.btn-danger:disabled {
  background: #9ca3af;
  border-color: #9ca3af;
  box-shadow: none;
  transform: none;
}

.client-name-section {
  margin-bottom: 24px;
}

.client-name-section label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--ink);
  font-size: 14px;
}

#clientNameInput {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
  transition: all 0.2s ease;
  background: white;
}

#clientNameInput:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(51, 111, 81, 0.1);
}

.input-help {
  font-size: 12px;
  color: var(--muted);
  margin-top: 6px;
}

.upload-section {
  margin-bottom: 20px;
}

.upload-section label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--ink);
}

/* Button base styles */
.btn {
  padding: 12px 20px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s ease;
  border: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  outline: none;
}

/* Button variants */
.btn-primary {
  background: var(--primary);
  color: white;
  border: 1px solid var(--primary);
}

.btn-primary:hover:not(:disabled) {
  background: var(--primary-dark);
  border-color: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(51, 111, 81, 0.25);
}

.btn-secondary {
  background: white;
  color: var(--ink);
  border: 1px solid var(--border);
}

.btn-secondary:hover:not(:disabled) {
  background: var(--soft);
  border-color: var(--muted);
}

.btn-danger {
  background: var(--error);
  color: white;
  border: 1px solid var(--error);
}

.btn-danger:hover:not(:disabled) {
  background: #c82333;
  border-color: #c82333;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.25);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* Modal actions spacing */
.modal-actions {
  background: var(--soft);
  padding: 20px 28px;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  border-top: 1px solid var(--hair);
}

/* Delete modal specific improvements */
.delete-modal-content {
  background: white;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 25px 80px rgba(0,0,0,.35);
}

.delete-modal-body {
  padding: 28px;
}

.delete-modal-body p {
  margin-bottom: 16px;
  line-height: 1.6;
  color: var(--ink);
}

/* Improve the warning box */
.delete-warning {
  background: linear-gradient(135deg, #fff3cd 0%, #fef7e0 100%);
  border: 1px solid #f0d000;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
  color: #856404;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-weight: 600;
}

/* Improve document info box */
.document-info {
  background: var(--soft);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
  font-size: 14px;
  color: var(--ink);
}

/* Improve checkbox styling */
.checkbox-container {
  display: flex;
  align-items: flex-start;
  cursor: pointer;
  font-size: 14px;
  line-height: 1.5;
  gap: 12px;
  padding: 16px;
  background: var(--soft);
  border-radius: 8px;
  border: 1px solid var(--border);
  transition: all 0.2s ease;
}

.checkbox-container:hover {
  background: rgba(51, 111, 81, 0.05);
  border-color: var(--primary);
}

.checkmark {
  width: 20px;
  height: 20px;
  background-color: white;
  border: 2px solid var(--border);
  border-radius: 6px;
  position: relative;
  flex-shrink: 0;
  margin-top: 2px;
  transition: all 0.2s ease;
}

.checkbox-container:hover .checkmark {
  border-color: var(--primary);
}

.checkbox-container input:checked + .checkmark {
  background-color: var(--primary);
  border-color: var(--primary);
}

.checkbox-container input:checked + .checkmark::after {
  content: '';
  position: absolute;
  left: 6px;
  top: 2px;
  width: 5px;
  height: 10px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

.delete-warning {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 16px;
  color: #856404;
  text-align: center;
}

.document-info {
  background: var(--soft);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 20px;
  font-size: 13px;
}

.delete-confirmation {
  margin-bottom: 20px;
}

.checkbox-container {
  display: flex;
  align-items: flex-start;
  cursor: pointer;
  font-size: 14px;
  line-height: 1.4;
  gap: 10px;
}

.checkbox-container input[type="checkbox"] {
  margin: 0;
  opacity: 0;
  position: absolute;
}

.checkmark {
  width: 18px;
  height: 18px;
  background-color: white;
  border: 2px solid var(--border);
  border-radius: 4px;
  position: relative;
  flex-shrink: 0;
  margin-top: 2px;
}

.checkbox-container:hover .checkmark {
  border-color: var(--primary);
}

.checkbox-container input:checked + .checkmark {
  background-color: var(--primary);
  border-color: var(--primary);
}

.checkbox-container input:checked + .checkmark::after {
  content: '';
  position: absolute;
  left: 5px;
  top: 2px;
  width: 4px;
  height: 8px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

.modal-upload-area {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 32px 24px;
  text-align: center;
  background: var(--soft);
  position: relative;
  transition: all 0.2s ease;
  cursor: pointer;
}

.modal-upload-area:hover {
  border-color: var(--primary);
  background: rgba(51, 111, 81, 0.02);
}

.modal-upload-input {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}

.upload-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.modal-upload-text {
  color: var(--muted);
}

.upload-hint {
  font-size: 12px;
  margin-top: 4px;
}

.selected-files {
  margin-top: 12px;
}

.file-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: var(--soft);
  border: 1px solid var(--border);
  border-radius: 6px;
  margin-bottom: 6px;
  font-size: 13px;
}

.file-remove {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 12px;
}

.file-remove:hover {
  background: rgba(220, 53, 69, 0.1);
  color: #dc3545;
}

.processing-info {
  background: #d1ecf1;
  border: 1px solid #bee5eb;
  border-radius: 8px;
  padding: 12px;
  font-size: 13px;
  color: #0c5460;
}

/* Responsive Design */
@media (max-width: 1400px) {
  .main-layout {
    grid-template-columns: 260px 1fr 300px;
    gap: 20px;
    padding: 20px 24px;
  }
}

@media (max-width: 1200px) {
  .main-layout {
    grid-template-columns: 240px 1fr;
    max-width: 1000px;
  }
  
  .generate-column {
    display: none;
  }
}

@media (max-width: 768px) {
  .header {
    padding: 0 16px;
    height: 60px;
  }
  
  .advisor-banner {
    margin-top: 60px;
    padding: 16px;
  }
  
  .main-layout {
    grid-template-columns: 1fr;
    gap: 16px;
    padding: 16px;
    height: calc(100vh - 120px);
  }
  
  .column-body {
    max-height: 400px;
  }
}
  /* Right Panel Upload Styles */
.upload-section-right {
  border-top: 1px solid var(--hair);
  padding-top: 20px;
  margin-top: 20px;
}

.upload-area-right {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 20px 16px;
  text-align: center;
  margin-bottom: 20px;
  background: var(--soft);
  position: relative;
  transition: all 0.3s ease;
  cursor: pointer;
}

.upload-area-right:hover {
  border-color: var(--primary);
  background: rgba(51, 111, 81, 0.02);
}

.upload-area-right .upload-input {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}

.upload-text-right {
  color: var(--muted);
  font-size: 13px;
  font-weight: 500;
  pointer-events: none;
}
  /* Action Sections */
.action-section {
  background: var(--card);
  border: 1px solid var(--hair);
  border-radius: 12px;
  margin-bottom: 20px;
  overflow: hidden;
}

.action-section:last-child {
  margin-bottom: 0;
}

.section-header {
  background: var(--soft);
  padding: 12px 16px;
  font-weight: 600;
  font-size: 15px;
  color: var(--ink);
  border-bottom: 1px solid var(--hair);
}

.generate-section .generator-form {
  padding: 16px;
  border-bottom: 1px solid var(--hair);
}

.upload-section .upload-area-right {
  margin: 16px;
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  background: var(--soft);
  position: relative;
  transition: all 0.3s ease;
  cursor: pointer;
}

.upload-section .upload-area-right:hover {
  border-color: var(--primary);
  background: rgba(51, 111, 81, 0.02);
}

.upload-area-right .upload-input {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}

.upload-text-right {
  color: var(--muted);
  font-size: 13px;
  font-weight: 500;
  pointer-events: none;
}

.queue-header {
  background: var(--bg);
  padding: 10px 16px;
  font-size: 13px;
  font-weight: 600;
  color: var(--ink);
  border-top: 1px solid var(--hair);
}

.queue-container {
  max-height: 150px;
  overflow-y: auto;
  min-height: 50px;
  padding: 8px;
}

.queue-container::-webkit-scrollbar {
  width: 6px;
}

.queue-container::-webkit-scrollbar-track {
  background: var(--soft);
  border-radius: 3px;
}

.queue-container::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

.queue-container::-webkit-scrollbar-thumb:hover {
  background: var(--muted);
}

.empty-queue {
  text-align: center;
  color: var(--muted);
  font-style: italic;
  padding: 20px 10px;
  font-size: 12px;
}
  
  /* Secondary Navigation */
.secondary-nav {
  background: #fff;
  border-bottom: 1px solid var(--border);
  padding: 0 32px;
  position: fixed;
  top: 72px;
  left: 0;
  right: 0;
  z-index: 999;
  height: 48px;
  display: flex;
  align-items: center;
}

.secondary-links {
  display: flex;
  gap: 32px;
}

.secondary-link {
  padding: 8px 16px;
  font-size: 14px;
  font-weight: 500;
  color: var(--muted);
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s ease;
  position: relative;
}

.secondary-link:hover {
  color: var(--ink);
  background: var(--soft);
}

.secondary-link.active {
  color: var(--primary);
  font-weight: 600;
}

.secondary-link.active::after {
  content: '';
  position: absolute;
  bottom: -20px;
  left: 50%;
  transform: translateX(-50%);
  width: 24px;
  height: 2px;
  background: var(--primary);
  border-radius: 1px;
}
</style>
</head>
<body>

<div class="header">
  <div class="logo-section">
    <div class="logo">DG</div>
    <div class="brand-info">
      <h1>DocuGen</h1>
      <div class="subtitle">By Doculabs</div>
    </div>
  </div>
  <h1 class="header-title">Advisor</h1>
</div>

    <!-- Secondary Nav -->
<nav class="secondary-nav">
  <div class="secondary-links">
    <div class="secondary-link">Dashboard</div>
    <div class="secondary-link active">Advisor</div>
    <div class="secondary-link">Research</div>
    <div class="secondary-link">Chat</div>
  </div>
</nav>
<div class="advisor-banner">
  <h2>Document Generation Platform</h2>
</div>
<div class="main-layout">
  
  <!-- Clients Column -->
  <div class="column clients-column">
    <div class="column-header">
      Clients
      <div class="client-header-actions">
        <button class="icon-btn refresh-clients-btn" onclick="loadClientsFromVertesia()" title="Refresh Client List">↻</button>
        <button class="icon-btn add-client-btn" onclick="openAddClientModal()" title="Add New Client">+</button>
      </div>
    </div>
    <div class="column-body">
      <div id="clientList"></div>
    </div>
  </div>

  <!-- Documents Column -->
<div class="column documents-column">
<div class="column-header" id="documentsHeader">
  <span>Documents</span>
  <div id="profileStatus" class="profile-status-inline">
    <!-- Will be populated dynamically -->
  </div>
</div>
  <div class="column-body">
    
    <!-- Remove the entire profile-status-section div from here -->
    
    <div class="doc-controls">
      <input type="text" class="search-bar" id="searchBar" placeholder="Search documents..." onkeyup="searchDocuments()">
      <span class="doc-control" onclick="sortDocuments()">Sort by Date</span>
      <span class="doc-control" onclick="toggleDocuments()">Toggle All</span>
    </div>
    
    <div class="doc-list" id="documentsList"></div>
  </div>
</div>
<!-- Generate & Upload Column -->
<!-- Generate & Upload Column -->
<div class="column generate-column">
  <div class="column-header">Generate & Upload</div>
  <div class="column-body">
    
    <!-- Generate Section -->
    <div class="action-section generate-section">
      <div class="section-header">Generate</div>
      <div class="generator-form">
        <select class="generator-select" id="docTypeSelect">
          <option value="">Select document type...</option>
          <option value="Portfolio Analysis">Portfolio Analysis</option>
          <option value="15 min Meeting Preparation">15 min Meeting Preparation</option>
          <option value="45 min Meeting Preparation">45 min Meeting Preparation</option>
          <option value="Quarterly Report">Quarterly Report</option>
          <option value="Tax Planning">Tax Planning Document</option>
          <option value="Retirement Planning">Retirement Planning</option>
          <option value="Client Current State">Client Current State</option>
          <option value="Risk Assessment">Risk Assessment</option>
          <option value="Compose Correspondence">Compose Correspondence</option>
        </select>
        <button class="generator-btn" id="generateBtn" onclick="generateDocument()">Generate</button>
      </div>
      
      <div class="queue-header">Generation Queue (<span id="generationActiveCount">0</span>/5)</div>
      <div class="queue-container" id="queueItems">
        <div class="empty-queue">No documents generating</div>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="action-section upload-section">
      <div class="section-header">Upload</div>
      <div class="upload-area-right">
        <input type="file" class="upload-input" id="fileUpload" onchange="handleFileUpload(event)" multiple accept=".pdf,.doc,.docx,.xlsx,.ppt,.pptx">
        <div class="upload-text-right">Drop files here or click to upload</div>
      </div>
      
      <div class="queue-header">Upload Queue (<span id="uploadQueueCount">0</span>)</div>
      <div class="queue-container" id="uploadQueueItems">
        <div class="empty-queue">No files uploading</div>
      </div>
    </div>
    
  </div>
</div>

<!-- Document Viewer Dialog -->
<dialog id="viewer" aria-label="Document viewer">
  <div class="viewer-header">
    <div class="viewer-title" id="viewerTitle">Document</div>
    <button type="button" class="close-btn" id="closeViewer">Close</button>
  </div>
  <iframe id="viewerFrame"></iframe>
</dialog>

<!-- Delete Confirmation Modal -->
<dialog id="deleteModal" aria-label="Delete confirmation">
  <div class="modal-content delete-modal-content">
    <div class="modal-header delete-modal-header">
      <h3>Delete Document</h3>
    </div>
    <div class="modal-body">
      <div class="delete-warning">
        <strong> This action <b>cannot</b>b be undone.</strong>
      </div>
      <p> </p>
      <div class="document-info">
        <strong>Document:</strong> <span id="deleteDocumentName"></span>
      </div>
      <div class="delete-confirmation">
        <label class="checkbox-container">
          <input type="checkbox" id="deleteConfirmCheck">
          <span class="checkmark"></span>
          I understand this action is permanent and cannot be reversed
        </label>
      </div>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" id="cancelDelete">Cancel</button>
      <button type="button" class="btn btn-danger" id="confirmDelete" disabled>Delete Document</button>
    </div>
  </div>
</dialog>

<!-- Add Client Modal -->
<dialog id="addClientModal" aria-label="Add new client">
  <div class="modal-content add-client-modal-content">
    <div class="modal-header add-client-modal-header">
      <h3>Add New Client</h3>
      <button type="button" class="modal-close-btn" onclick="closeAddClientModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="clientNameInput">Client Name</label>
        <input type="text" class="form-input" id="clientNameInput" placeholder="John Smith" autocomplete="off">
        <div class="input-help">Enter the client's full name (first and last)</div>
      </div>
      
      <div class="form-group">
        <label>Initial Documents (Optional)</label>
        <div class="modal-upload-area">
          <input type="file" class="modal-upload-input" id="clientFileUpload" multiple accept=".pdf,.doc,.docx,.xlsx,.ppt,.pptx">
          <div class="modal-upload-text">
            <div class="upload-icon">📄</div>
            <div>Drop files here or click to upload</div>
            <div class="upload-hint">Upload documents for this client</div>
          </div>
        </div>
        <div id="selectedFilesList" class="selected-files"></div>
      </div>
      
      <div class="processing-info">
        <strong>Note:</strong> After creating the client, it may take 1-2 minutes for uploaded documents to appear in the system while they are being processed.
      </div>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" onclick="closeAddClientModal()">Cancel</button>
      <button type="button" class="btn btn-primary" id="createClientBtn" onclick="createNewClient()">Create Client</button>
    </div>
  </div>
</dialog>

<script>
  // Rate limiting variables
let lastGenerationTime = 0;
const GENERATION_COOLDOWN = 10000; // 10 seconds in milliseconds
const MAX_CONCURRENT_GENERATIONS = 5;
  
// Dynamic client data - will be populated from Vertesia
let clientsData = {};

// Document data - starts empty, will be populated by API
let documentsData = [];

let currentClient = null;
let sortOrder = 'desc';
let documentsVisible = true;
let selectedFiles = [];
  
// Upload Queue Variables (background processing)
let uploadQueue = [];
let isUploadProcessing = false;
let uploadQueueId = 0;
  
// Load clients dynamically from Vertesia
async function loadClientsFromVertesia() {
  try {
    console.log('Loading clients from Vertesia...');
    
    const response = await fetch('https://api.vertesia.io/api/v1/objects?limit=1000&offset=0', {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`Failed to fetch documents: ${response.status}`);
    }
    
    const documents = await response.json();
    console.log(`Found ${documents.length} documents in Vertesia`);
    
    // Extract unique client names with better logic
    const clientNamesMap = new Map(); // Use Map to track normalized names and pick best version
    
    documents.forEach(doc => {
      let clientName = null;
      
      // Check document properties first
      if (doc.properties && doc.properties.client) {
        clientName = doc.properties.client;
      }
      // Enhanced extraction from document name
      else if (doc.name) {
        // Pattern 1: Standard " - " format
        if (doc.name.includes(' - ')) {
          clientName = doc.name.split(' - ')[0].trim();
        }
        // Pattern 2: Underscore separated (Chris_Lehman_Document.pdf)
        else if (doc.name.includes('_')) {
          const parts = doc.name.split('_');
          if (parts.length >= 2) {
            // Take first two parts as first/last name
            clientName = `${parts[0]} ${parts[1]}`;
          }
        }
        // Pattern 3: Look for common name patterns
        else {
          const nameMatch = doc.name.match(/^([A-Z][a-z]+\s+[A-Z][a-z]+)/);
          if (nameMatch) {
            clientName = nameMatch[1];
          }
        }
      }
      
      // Clean up and validate client name
      if (clientName) {
        // Remove file extensions and clean up
        clientName = clientName.replace(/\.(pdf|docx?|xlsx?|pptx?)$/i, '').trim();
        
        // Only process if it looks like a real name (has at least first and last)
        if (clientName.includes(' ') && clientName.split(' ').length >= 2) {
          
          // Normalize the name for comparison (lowercase, single spaces)
          const normalizedName = clientName.toLowerCase()
            .replace(/\s+/g, ' ')  // Replace multiple spaces with single space
            .trim();
          
          // If we haven't seen this normalized name before, or if this version looks "better"
          if (!clientNamesMap.has(normalizedName)) {
            clientNamesMap.set(normalizedName, clientName);
          } else {
            // Keep the version with proper capitalization if current one is all lowercase
            const existing = clientNamesMap.get(normalizedName);
            if (existing === existing.toLowerCase() && clientName !== clientName.toLowerCase()) {
              clientNamesMap.set(normalizedName, clientName);
            }
          }
        }
      }
    });
    
    // Convert to array, sort alphabetically, then convert to clientsData format
    const sortedEntries = Array.from(clientNamesMap.entries()).sort((a, b) => 
      a[1].localeCompare(b[1]) // Sort by display name
    );
    
    clientsData = {};
    sortedEntries.forEach(([normalizedName, displayName]) => {
      const clientId = normalizedName.replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '');
      clientsData[clientId] = { name: displayName };
    });
    
    console.log('Loaded unique clients in A-Z order:', Object.values(clientsData).map(c => c.name));
    
    renderClients();
    
    if (!currentClient || !clientsData[currentClient]) {
      const firstClientId = Object.keys(clientsData)[0];
      if (firstClientId) {
        switchClient(firstClientId);
      }
    } else {
      await loadClientDocuments(currentClient);
    }
    
  } catch (error) {
    console.error('Failed to load clients from Vertesia:', error);
  }
}

// Test Vertesia API function
async function testVertesiaAPI() {
  const testBtn = document.getElementById('testApiBtn');
  testBtn.disabled = true;
  testBtn.textContent = 'Testing...';
  
  try {
    console.log('Making API call to Vertesia...');
    
    const response = await fetch('https://api.vertesia.io/api/v1/objects?limit=100&offset=0', {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      }
    });
    
    console.log('Response status:', response.status);
    
    if (response.ok) {
      const result = await response.json();
      console.log('API Response:', result);
      console.log('Number of documents:', Array.isArray(result) ? result.length : 'Response is not an array');
      
      alert(`Successfully loaded ${result.length} documents! Check console for details.`);
      
      // Refresh client list after test
      await loadClientsFromVertesia();
      
    } else {
      const errorText = await response.text();
      console.error('API Error Response:', errorText);
      alert(`API call failed with status ${response.status}. Check console for details.`);
    }
  } catch (error) {
    console.error('Network error:', error);
    alert('Network error occurred. Check console for details.');
  } finally {
    testBtn.disabled = false;
    testBtn.textContent = 'Test API Call';
  }
}

function extractClientFromName(docName) {
  if (!docName) return 'all';
  
  for (const [clientId, client] of Object.entries(clientsData)) {
    if (docName.toLowerCase().includes(client.name.toLowerCase())) {
      return clientId;
    }
  }
  return 'all';
}

// AI Profile Functions
function checkClientProfile(clientId) {
  const client = clientsData[clientId];
  if (!client) return false;
  
  // Get client's first and last name parts
  const nameParts = client.name.split(' ');
  const firstName = nameParts[0];
  const lastName = nameParts[1] || '';
  
  // Look for AI profile document with flexible matching
  return documentsData.some(doc => {
    // Must be associated with this client
    if (doc.client !== clientId) return false;
    
    // Convert document name to lowercase for case-insensitive matching
    const docNameLower = doc.name.toLowerCase();
    
    // Check if document contains AI profile indicators
    const hasAIProfile = docNameLower.includes('ai_profile') || 
                        docNameLower.includes('ai profile') ||
                        docNameLower.includes('aiprofile');
    
    // Check if document contains client's name
    const hasClientName = docNameLower.includes(firstName.toLowerCase()) &&
                         (lastName === '' || docNameLower.includes(lastName.toLowerCase()));
    
    return hasAIProfile && hasClientName;
  });
}

function updateProfileStatus() {
  const profileStatus = document.getElementById('profileStatus');
  
  if (!currentClient || !clientsData[currentClient]) {
    profileStatus.innerHTML = '';
    return;
  }
  
  const hasProfile = checkClientProfile(currentClient);
  
  if (hasProfile) {
    profileStatus.innerHTML = `
      <div class="profile-complete-inline">
        <span class="status-light-inline green"></span>
        <span>AI Profile Complete</span>
      </div>
    `;
  } else {
    profileStatus.innerHTML = `
      <div class="profile-needed-inline">
        <span class="status-light-inline red"></span>
        <span>AI Profile Required</span>
        <button class="generate-profile-btn-inline" onclick="generateAIProfile()">
          Generate
        </button>
      </div>
    `;
  }
}

async function generateAIProfile() {
  if (!currentClient || !clientsData[currentClient]) {
    alert('Please select a client first');
    return;
  }

  // Rate limiting checks
  const now = Date.now();
  const timeSinceLastGeneration = now - lastGenerationTime;
  const activeGenerations = documentQueue.activeGenerations.size;
  
  // Check cooldown period
  if (timeSinceLastGeneration < GENERATION_COOLDOWN) {
    const remainingTime = Math.ceil((GENERATION_COOLDOWN - timeSinceLastGeneration) / 1000);
    alert(`Please wait ${remainingTime} more seconds before generating another document.`);
    return;
  }
  
  // Check concurrent generation limit
  if (activeGenerations >= MAX_CONCURRENT_GENERATIONS) {
    alert(`Maximum of ${MAX_CONCURRENT_GENERATIONS} documents can be generated at once. Please wait for some to complete.`);
    return;
  }

  const profileBtn = document.querySelector('.generate-profile-btn, .generate-profile-btn-inline');
  if (profileBtn) {
    profileBtn.disabled = true;
    profileBtn.textContent = 'Generating...';
  }

  // Update last generation time
  lastGenerationTime = now;

  // Add to queue
  documentQueue.addGeneration('AI Profile', currentClient);

  try {
    await fetch('https://api.vertesia.io/api/v1/execute/async', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
      },
      body: JSON.stringify({
        "type": "conversation",
        "interaction": "TESTFinancialProfileGenerator@2",
        "data": {
          "task": `For ${clientsData[currentClient].name} create an AI Profile`
        },
        "config": {
          "environment": "681915c6a01fb262a410c161",
          "model": "publishers/anthropic/models/claude-3-7-sonnet"
        }
      })
    });
    
    console.log(`AI Profile generation started for ${clientsData[currentClient].name}`);
  } catch (error) {
    console.error('AI Profile generation error:', error);
    alert('Failed to generate AI Profile. Please try again.');
  } finally {
    if (profileBtn) {
      profileBtn.disabled = false;
      profileBtn.textContent = profileBtn.classList.contains('generate-profile-btn-inline') ? 'Generate' : 'Generate AI Profile';
    }
  }
}

// Document Queue Class
class DocumentQueue {
  constructor() {
    this.activeGenerations = new Map();
    this.timers = new Map();
  }
  
  addGeneration(docType, clientId) {
    const id = Date.now() + Math.random();
    const generation = {
      id,
      docType,
      clientId,
      clientName: clientsData[clientId].name,
      startTime: Date.now(),
      estimatedDuration: 5 * 60 * 1000
    };
    
    this.activeGenerations.set(id, generation);
    this.startTimer(id);
    this.updateQueueDisplay();
    return id;
  }
  
  startTimer(id) {
    const timer = setInterval(() => {
      const generation = this.activeGenerations.get(id);
      if (!generation) {
        clearInterval(timer);
        return;
      }
      
      const elapsed = Date.now() - generation.startTime;
      if (elapsed >= generation.estimatedDuration) {
        this.completeGeneration(id);
      }
      this.updateQueueDisplay();
    }, 1000);
    
    this.timers.set(id, timer);
  }
  
  completeGeneration(id) {
    const generation = this.activeGenerations.get(id);
    if (generation) {
      const newDoc = {
        id: Date.now(),
        name: generation.docType,
        date: new Date().toISOString().split('T')[0],
        client: generation.clientId,
        type: 'generated'
      };
      
      documentsData.unshift(newDoc);
      if (generation.clientId === currentClient) {
        renderDocuments();
        updateProfileStatus();
      }
    }
    
    this.removeGeneration(id);
  }
  
  removeGeneration(id) {
    clearInterval(this.timers.get(id));
    this.timers.delete(id);
    this.activeGenerations.delete(id);
    this.updateQueueDisplay();
  }
  
  // FIX: Make this a proper method of the class
  updateQueueDisplay() {
    const itemsElement = document.getElementById('queueItems');
    const queueHeader = document.querySelector('.queue-header');
    
    // Update header to show current status
    const activeCount = this.activeGenerations.size;
    queueHeader.textContent = `In Queue (${activeCount}/${MAX_CONCURRENT_GENERATIONS})`;
    
    itemsElement.innerHTML = '';
    
    this.activeGenerations.forEach(generation => {
      const elapsed = Date.now() - generation.startTime;
      const remaining = Math.max(0, generation.estimatedDuration - elapsed);
      const minutes = Math.floor(remaining / 60000);
      const seconds = Math.floor((remaining % 60000) / 1000);
      
      const div = document.createElement('div');
      div.className = 'queue-item';
      div.innerHTML = `
        <div class="spinner"></div>
        <div class="queue-item-content">
          <div class="queue-item-name">${generation.docType}</div>
          <div class="queue-item-client">${generation.clientName}</div>
        </div>
        <span class="queue-timer">${minutes}:${seconds.toString().padStart(2, '0')}</span>
        <button class="queue-cancel" onclick="documentQueue.removeGeneration(${generation.id})">✕</button>
      `;
      itemsElement.appendChild(div);
    });
  }
}


const documentQueue = new DocumentQueue();
// Viewer Functions
function openFormattedViewer(markdownContent, title) {
  const dlg = document.getElementById('viewer');
  document.getElementById('viewerTitle').textContent = title;
  
  // Convert markdown to HTML
  const htmlContent = marked.parse(markdownContent);
  
  // Replace iframe with formatted content div
  const viewerFrame = document.getElementById('viewerFrame');
  viewerFrame.outerHTML = `<div id="viewerFrame" class="viewer-content">${htmlContent}</div>`;
  
  dlg.showModal();
}

function closeViewer() {
  const dlg = document.getElementById('viewer');
  const viewerFrame = document.getElementById('viewerFrame');
  
  // Reset to iframe structure for next use
  viewerFrame.outerHTML = '<iframe id="viewerFrame"></iframe>';
  
  if (dlg?.open) dlg.close();
}

// Add a regular viewer function for PDFs/Office docs
function openViewer(url, title) {
  const dlg = document.getElementById('viewer');
  document.getElementById('viewerTitle').textContent = title || 'Document';
  document.getElementById('viewerFrame').src = url;
  dlg.showModal();
}

  // Add this function to show cooldown on button
function updateGenerateButtonCooldown() {
  const generateBtn = document.getElementById('generateBtn');
  const now = Date.now();
  const timeSinceLastGeneration = now - lastGenerationTime;
  const remainingCooldown = GENERATION_COOLDOWN - timeSinceLastGeneration;
  
  if (remainingCooldown > 0) {
    const seconds = Math.ceil(remainingCooldown / 1000);
    generateBtn.textContent = `Generate (${seconds}s)`;
    generateBtn.disabled = true;
    
    setTimeout(updateGenerateButtonCooldown, 1000);
  } else {
    generateBtn.textContent = 'Generate';
    generateBtn.disabled = false;
  }
}
// Search documents
function searchDocuments() {
  const query = document.getElementById('searchBar').value.toLowerCase();
  renderDocuments(query);
}

// Sort documents
function sortDocuments() {
  sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
  renderDocuments();
}

// Toggle documents
function toggleDocuments() {
  documentsVisible = !documentsVisible;
  const docItems = document.querySelectorAll('.doc-item');
  docItems.forEach(item => {
    item.style.display = documentsVisible ? 'flex' : 'none';
  });
}

// Render documents
function renderDocuments(searchQuery = '') {
  const docsList = document.getElementById('documentsList');
  docsList.innerHTML = '';
  
  // Update profile status first
  updateProfileStatus();
  
  let filteredDocs = documentsData.filter(doc => 
    (doc.client === currentClient || doc.client === 'all') &&
    (searchQuery === '' || doc.name.toLowerCase().includes(searchQuery))
  );
  
  if (filteredDocs.length === 0) {
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'empty-state';
    emptyDiv.textContent = 'No documents found. Try uploading files or generating new documents.';
    docsList.appendChild(emptyDiv);
    return;
  }
  
  filteredDocs.sort((a, b) => {
    const dateA = new Date(a.date);
    const dateB = new Date(b.date);
    return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
  });
  
  filteredDocs.forEach((doc, index) => {
    const div = document.createElement('div');
    div.className = 'doc-item';
    div.innerHTML = `
      <div class="doc-info">
        <div class="doc-name">${doc.name}</div>
        <div class="doc-date">${doc.date}</div>
      </div>
      <div class="doc-actions">
        <span class="doc-action" onclick="viewDocument('${doc.id}')">view</span>
        <span class="doc-action" onclick="downloadDocument('${doc.id}')">download</span>
        <span class="doc-action" onclick="deleteDocument('${doc.id}')">delete</span>
      </div>
    `;
    docsList.appendChild(div);
  });
}
// Call this after each generation
// Add to generateDocument() and generateAIProfile() after lastGenerationTime = now;
setTimeout(updateGenerateButtonCooldown, 100);
// Initialize
async function init() {
  // Load clients from Vertesia first
  await loadClientsFromVertesia();
  
  // Initialize viewer
  document.getElementById('closeViewer').addEventListener('click', closeViewer);
  
  document.getElementById('viewer').addEventListener('click', (e) => {
    const r = e.target.getBoundingClientRect();
    const outside = e.clientX < r.left || e.clientX > r.right || e.clientY < r.top || e.clientY > r.bottom;
    if (outside) closeViewer();
  });
  
  // Initialize delete modal
  document.getElementById('cancelDelete').addEventListener('click', cancelDocumentDelete);
  document.getElementById('confirmDelete').addEventListener('click', confirmDocumentDelete);
  
  // Checkbox validation for delete button
  document.getElementById('deleteConfirmCheck').addEventListener('change', function() {
    document.getElementById('confirmDelete').disabled = !this.checked;
  });
  
  // Add client modal file handling
  document.getElementById('clientFileUpload').addEventListener('change', function(event) {
    const files = Array.from(event.target.files);
    selectedFiles = [...selectedFiles, ...files];
    updateSelectedFilesList();
    event.target.value = '';
  });
  
  // Escape key handling
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('viewer').open) closeViewer();
    if (e.key === 'Escape' && document.getElementById('deleteModal').open) cancelDocumentDelete();
    if (e.key === 'Escape' && document.getElementById('addClientModal').open) closeAddClientModal();
  });
}

// Render client list
function renderClients() {
  const clientList = document.getElementById('clientList');
  clientList.innerHTML = '';
  
  if (Object.keys(clientsData).length === 0) {
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'empty-state';
    emptyDiv.textContent = 'No clients found. Add a client to get started.';
    clientList.appendChild(emptyDiv);
    return;
  }
  
  // Sort clients alphabetically by last name, then first name
  const sortedClients = Object.entries(clientsData).sort((a, b) => {
    const namePartsA = a[1].name.split(' ');
    const namePartsB = b[1].name.split(' ');
    
    const lastNameA = namePartsA[namePartsA.length - 1]; // Get last part as last name
    const lastNameB = namePartsB[namePartsB.length - 1];
    
    // First sort by last name
    const lastNameCompare = lastNameA.localeCompare(lastNameB);
    if (lastNameCompare !== 0) return lastNameCompare;
    
    // If last names are the same, sort by first name
    const firstNameA = namePartsA[0];
    const firstNameB = namePartsB[0];
    return firstNameA.localeCompare(firstNameB);
  });
  
  sortedClients.forEach(([clientId, client]) => {
    const div = document.createElement('div');
    div.className = `client-item ${clientId === currentClient ? 'active' : ''}`;
    
    // Convert "First Last" to "Last, First"
    const nameParts = client.name.split(' ');
    const firstName = nameParts[0];
    const lastName = nameParts[nameParts.length - 1];
    const displayName = `${lastName}, ${firstName}`;
    
    div.textContent = displayName;
    div.onclick = () => switchClient(clientId);
    clientList.appendChild(div);
  });
}

// Switch client
async function switchClient(clientId) {
  currentClient = clientId;
  const client = clientsData[clientId];
  
  if (!client) return;
  
  // Update UI - just show client name, profile status will be separate
  document.getElementById('documentsHeader').querySelector('span').textContent = `${client.name} Documents`;
  renderClients();
  
  // Load documents for this specific client
  await loadClientDocuments(clientId);
  
  // Update profile status after loading documents
  updateProfileStatus();
}

async function loadClientDocuments(clientId) {
  const client = clientsData[clientId];
  
  if (!client) return;
  
  try {
    // Search for documents containing this client's name
    const response = await fetch(`https://api.vertesia.io/api/v1/objects?name=${encodeURIComponent(client.name)}&limit=50`, {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const result = await response.json();
      
      // Convert to our format and assign to current client
      documentsData = result.map(doc => ({
        id: doc.id,
        name: doc.name,
        date: doc.created_at || doc.updated_at,
        client: clientId,
        type: 'vertesia',
        vertesiaId: doc.id
      }));
      
      renderDocuments();
    }
  } catch (error) {
    console.error('Failed to load client documents:', error);
  }
}

// Add Client Functions
function openAddClientModal() {
  document.getElementById('addClientModal').showModal();
  document.getElementById('clientNameInput').focus();
  selectedFiles = [];
  updateSelectedFilesList();
}

function closeAddClientModal() {
  document.getElementById('addClientModal').close();
  document.getElementById('clientNameInput').value = '';
  selectedFiles = [];
  updateSelectedFilesList();
}

function updateSelectedFilesList() {
  const filesList = document.getElementById('selectedFilesList');
  filesList.innerHTML = '';
  
  selectedFiles.forEach((file, index) => {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = `
      <span>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
      <button type="button" class="file-remove" onclick="removeFile(${index})">Remove</button>
    `;
    filesList.appendChild(fileItem);
  });
}

function removeFile(index) {
  selectedFiles.splice(index, 1);
  updateSelectedFilesList();
}

async function createNewClient() {
  const clientName = document.getElementById('clientNameInput').value.trim();
  
  if (!clientName) {
    alert('Please enter a client name');
    return;
  }
  
  if (clientName.split(' ').length < 2) {
    alert('Please enter both first and last name');
    return;
  }
  
  // Check if client already exists
  const existingClient = Object.values(clientsData).find(
    client => client.name.toLowerCase() === clientName.toLowerCase()
  );
  
  if (existingClient) {
    alert('A client with this name already exists');
    return;
  }
  
  const createBtn = document.getElementById('createClientBtn');
  createBtn.disabled = true;
  createBtn.textContent = 'Creating...';
  
  try {
    // Add files to background upload queue if any were selected
    if (selectedFiles.length > 0) {
      createBtn.textContent = 'Adding documents to queue...';
      
      selectedFiles.forEach(file => {
        const newFileName = generateFileName(clientName, file.name);
        uploadQueue.push({
          id: ++uploadQueueId,
          file: file,
          originalName: file.name,
          newName: newFileName,
          clientName: clientName
        });
        console.log(`Added to queue: ${file.name} -> ${newFileName}`);
      });
      
      // Start background processing
      processUploadQueue();
    }
    
    // Add client to local data immediately
    const clientId = clientName.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '');
    clientsData[clientId] = { name: clientName };
    
    // Reload clients from Vertesia to pick up any new documents
    createBtn.textContent = 'Refreshing...';
    await loadClientsFromVertesia();
    
    // Switch to the new client
    if (clientsData[clientId]) {
      switchClient(clientId);
    }
    
    // Close modal
    closeAddClientModal();
    
    // Show success message
    const fileCount = selectedFiles.length;
    let message = `Client "${clientName}" created successfully!`;
    if (fileCount > 0) {
      message += ` ${fileCount} document(s) are being processed in the background.`;
    }
    alert(message);
    
    // Schedule document refresh if files were uploaded
    if (fileCount > 0) {
      const refreshDelay = Math.max(fileCount * 3000, 10000);
      setTimeout(() => {
        loadClientDocuments(clientId);
      }, refreshDelay);
    }
    
  } catch (error) {
    console.error('Error creating client:', error);
    alert(`Failed to create client: ${error.message}`);
  } finally {
    createBtn.disabled = false;
    createBtn.textContent = 'Create Client';
  }
}

// File upload
function generateFileName(clientName, originalFileName) {
  if (!clientName.trim()) return originalFileName;
  
  const nameParts = clientName.trim().split(' ');
  const firstName = nameParts[0] || '';
  const lastName = nameParts[1] || '';
  
  // Remove extension from original file
  const fileNameWithoutExt = originalFileName.replace(/\.[^/.]+$/, '');
  const extension = originalFileName.split('.').pop();
  
  // Create abbreviated document title (first 3 words, max 20 chars)
  const abbreviatedTitle = fileNameWithoutExt
    .split(' ')
    .slice(0, 3)
    .join('_')
    .substring(0, 20)
    .replace(/[^a-zA-Z0-9_]/g, '');
  
  return `${firstName}_${lastName}_${abbreviatedTitle}.${extension}`;
}

async function handleFileUpload(event) {
  const files = Array.from(event.target.files);
  if (files.length === 0) return;
  
  if (!currentClient || !clientsData[currentClient]) {
    alert('Please select a client first');
    return;
  }
  
  const clientName = clientsData[currentClient].name;
  
  // Add files to background queue
  files.forEach(file => {
    const newFileName = generateFileName(clientName, file.name);
    uploadQueue.push({
      id: ++uploadQueueId,
      file: file,
      originalName: file.name,
      newName: newFileName,
      clientName: clientName
    });
  });
  
  // Start processing immediately in background
  processUploadQueue();
  
  // Schedule refresh based on number of files
  const refreshDelay = Math.max(files.length * 3000, 10000); // 3 seconds per file, minimum 10 seconds
  setTimeout(() => {
    loadClientDocuments(currentClient);
  }, refreshDelay);
  
  alert(`${files.length} file(s) added to upload queue. They will be processed in the background.`);
  event.target.value = '';
}

async function processUploadQueue() {
  if (isUploadProcessing || uploadQueue.length === 0) return;
  
  isUploadProcessing = true;
  
  while (uploadQueue.length > 0) {
    const queueItem = uploadQueue.shift();
    
    try {
      await uploadSingleFile(queueItem);
      console.log(`Successfully uploaded: ${queueItem.newName}`);
    } catch (error) {
      console.error(`Failed to upload: ${queueItem.newName}`, error);
    }
    
    // 3-5 second delay between uploads
    if (uploadQueue.length > 0) {
      const delay = 3000 + Math.random() * 2000;
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
  
  isUploadProcessing = false;
}

async function uploadSingleFile(queueItem) {
  const file = queueItem.file;
  const fileName = queueItem.newName;
  
  // Step 1: Get upload URL
  const urlResponse = await fetch('https://api.vertesia.io/api/v1/objects/upload-url', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
    },
    body: JSON.stringify({
      "name": fileName,
      "mime_type": file.type || "application/pdf"
    })
  });
  
  if (!urlResponse.ok) {
    throw new Error(`Failed to get upload URL: ${urlResponse.status}`);
  }
  
  const uploadData = await urlResponse.json();
  
  // Step 2: Upload to Google Cloud Storage
  const fileUploadResponse = await fetch(uploadData.url, {
    method: 'PUT',
    body: file
  });
  
  if (!fileUploadResponse.ok) {
    throw new Error(`Failed to upload file: ${fileUploadResponse.status}`);
  }
  
  // Step 3: Create the content object in Vertesia (FIXED)
  const createObjectResponse = await fetch('https://api.vertesia.io/api/v1/objects', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
    },
    body: JSON.stringify({
      "name": fileName,
      "description": `Document uploaded for ${queueItem.clientName}`,
      "content": {
        "source": uploadData.id,  // FIXED: Use the id directly
        "type": file.type || "application/pdf",
        "name": fileName
      },
      "properties": {
        "client": queueItem.clientName,
        "original_name": queueItem.originalName,
        "uploaded_at": new Date().toISOString()
      }
    })
  });
  
  if (!createObjectResponse.ok) {
    const errorText = await createObjectResponse.text();
    throw new Error(`Failed to create object: ${createObjectResponse.status}`);
  }
  
  return await createObjectResponse.json();
}
  
// Generate document - Updated with AI Profile check
async function generateDocument() {
  if (!currentClient || !clientsData[currentClient]) {
    alert('Please select a client first');
    return;
  }
  
  // Check if client has AI profile before generating documents
  if (!checkClientProfile(currentClient)) {
    alert('Please generate an AI Profile for this client first before creating other documents.');
    return;
  }
  
  // Rate limiting checks
  const now = Date.now();
  const timeSinceLastGeneration = now - lastGenerationTime;
  const activeGenerations = documentQueue.activeGenerations.size;
  
  // Check cooldown period
  if (timeSinceLastGeneration < GENERATION_COOLDOWN) {
    const remainingTime = Math.ceil((GENERATION_COOLDOWN - timeSinceLastGeneration) / 1000);
    alert(`Please wait ${remainingTime} more seconds before generating another document.`);
    return;
  }
  
  // Check concurrent generation limit
  if (activeGenerations >= MAX_CONCURRENT_GENERATIONS) {
    alert(`Maximum of ${MAX_CONCURRENT_GENERATIONS} documents can be generated at once. Please wait for some to complete.`);
    return;
  }
  
  const select = document.getElementById('docTypeSelect');
  const selectedDocType = select.value;
  
  if (!selectedDocType) {
    alert('Please select a document type');
    return;
  }
  
  // Update last generation time
  lastGenerationTime = now;
  
  // Add to queue with the captured value
  documentQueue.addGeneration(selectedDocType, currentClient);
  
  // Now reset the select
  select.value = '';
  
  try {
    await fetch('https://api.vertesia.io/api/v1/execute/async', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
      },
      body: JSON.stringify({
        "type": "conversation",
        "interaction": "AdvisorAssistant@2",
        "data": {
          "task": `For ${clientsData[currentClient].name} create a ${selectedDocType} document`
        },
        "config": {
          "environment": "681915c6a01fb262a410c161",
          "model": "publishers/anthropic/models/claude-3-7-sonnet"
        }
      })
    });
    
    console.log(`Document generation started: ${selectedDocType} for ${clientsData[currentClient].name}`);
  } catch (error) {
    console.error('API error:', error);
  }
}
// Document actions
async function viewDocument(id) {
  const doc = documentsData.find(d => d.id === id);
  
  if (!doc || !doc.vertesiaId) {
    alert('Cannot view this document - missing ID');
    return;
  }
  
  try {
    console.log(`Getting object details for ${doc.vertesiaId}...`);
    const objectResponse = await fetch(`https://api.vertesia.io/api/v1/objects/${doc.vertesiaId}`, {
      headers: { 
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9' 
      }
    });
    
    if (!objectResponse.ok) {
      throw new Error(`Failed to get object: ${objectResponse.status}`);
    }
    
    const objectData = await objectResponse.json();
    
    console.log('Full object data:', objectData);
    console.log('Content type:', objectData.content?.type);
    console.log('Document name:', doc.name);
    
    const fileUri = objectData.content?.source;
    if (!fileUri) {
      throw new Error('No file source found in object');
    }
    
    // Get the download URL
    const downloadResponse = await fetch('https://api.vertesia.io/api/v1/objects/download-url', {
      method: 'POST',
      headers: { 
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ "file": fileUri })
    });
    
    if (!downloadResponse.ok) {
      throw new Error(`Failed to get download URL: ${downloadResponse.status}`);
    }
    
    const downloadData = await downloadResponse.json();
    
    // Fetch the content to see what we actually get
    const contentResponse = await fetch(downloadData.url);
    const contentType = contentResponse.headers.get('content-type');
    console.log('Actual content type from URL:', contentType);
    
    // Check if it's text-based content (markdown, HTML, plain text)
    if (contentType?.includes('text/') || 
        objectData.content?.type === 'text/markdown' ||
        objectData.content?.type?.includes('text/')) {
      
      const textContent = await contentResponse.text();
      console.log('Text content preview:', textContent.substring(0, 500));
      
      // Try to determine if it's markdown
      if (textContent.includes('# ') || textContent.includes('## ') || 
          objectData.content?.type === 'text/markdown') {
        console.log('Treating as markdown');
        openFormattedViewer(textContent, doc.name);
      } else {
        console.log('Treating as plain text/HTML');
        // Display as plain text or HTML
        const dlg = document.getElementById('viewer');
        document.getElementById('viewerTitle').textContent = doc.name;
        const viewerFrame = document.getElementById('viewerFrame');
        viewerFrame.outerHTML = `<div id="viewerFrame" class="viewer-content"><pre style="white-space: pre-wrap; font-family: inherit;">${textContent}</pre></div>`;
        dlg.showModal();
      }
      
    } else {
      console.log('Treating as binary file, opening in iframe');
      // For PDFs and other binary files
      openViewer(downloadData.url, doc.name);
    }
    
  } catch (error) {
    console.error('View document error:', error);
    alert(`Failed to view document: ${error.message}`);
  }
}

async function downloadDocument(id) {
  const doc = documentsData.find(d => d.id === id);
  
  if (!doc || !doc.vertesiaId) {
    alert('Cannot download this document - missing ID');
    return;
  }
  
  try {
    console.log(`Getting object details for download: ${doc.vertesiaId}...`);
    const objectResponse = await fetch(`https://api.vertesia.io/api/v1/objects/${doc.vertesiaId}`, {
      headers: { 
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9' 
      }
    });
    
    if (!objectResponse.ok) {
      throw new Error(`Failed to get object: ${objectResponse.status}`);
    }
    
    const objectData = await objectResponse.json();
    const fileUri = objectData.content?.source;
    
    if (!fileUri) {
      throw new Error('No file source found in object');
    }
    
    console.log('Getting signed download URL...');
    let downloadResponse = await fetch('https://api.vertesia.io/api/v1/objects/download-url', {
      method: 'POST',
      headers: { 
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        "file": fileUri,
        "format": "original"
      })
    });
    
    if (!downloadResponse.ok) {
      console.log('Format parameter failed, trying without format...');
      downloadResponse = await fetch('https://api.vertesia.io/api/v1/objects/download-url', {
        method: 'POST',
        headers: { 
          'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
          "file": fileUri
        })
      });
    }
    
    if (!downloadResponse.ok) {
      throw new Error(`Failed to get download URL: ${downloadResponse.status}`);
    }
    
    const downloadData = await downloadResponse.json();
    
    // Fetch the markdown content
    console.log('Downloading and formatting content...');
    const textResponse = await fetch(downloadData.url);
    const markdownContent = await textResponse.text();
    
    // Convert to formatted HTML
    const htmlContent = marked.parse(markdownContent);
    
    // Create a temporary div with the formatted content
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;
    tempDiv.style.cssText = `
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #1f2d3d;
      max-width: 900px;
      margin: 0 auto;
      padding: 30px 40px;
    `;
    
    // Apply styling to elements
    tempDiv.querySelectorAll('h1').forEach(h1 => {
      h1.style.cssText = `
        font-size: 28px;
        color: #336F51;
        border-bottom: 3px solid #336F51;
        padding-bottom: 12px;
        margin: 30px 0 20px 0;
        font-weight: 700;
      `;
    });
    
    tempDiv.querySelectorAll('h2').forEach(h2 => {
      h2.style.cssText = `
        font-size: 22px;
        color: #1f2d3d;
        margin: 25px 0 15px 0;
        font-weight: 600;
        border-left: 4px solid #336F51;
        padding-left: 12px;
      `;
    });
    
    tempDiv.querySelectorAll('h3').forEach(h3 => {
      h3.style.cssText = `
        font-size: 18px;
        color: #1f2d3d;
        margin: 20px 0 12px 0;
        font-weight: 600;
      `;
    });
    
    tempDiv.querySelectorAll('p').forEach(p => {
      p.style.cssText = 'margin-bottom: 16px; text-align: justify;';
    });
    
    tempDiv.querySelectorAll('strong').forEach(strong => {
      strong.style.cssText = 'color: #336F51; font-weight: 600;';
    });
    
    tempDiv.querySelectorAll('table').forEach(table => {
      table.style.cssText = `
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        font-size: 14px;
      `;
      
      table.querySelectorAll('th').forEach(th => {
        th.style.cssText = `
          background-color: #f8f9fb;
          border: 1px solid #e0e5ea;
          padding: 12px 8px;
          text-align: left;
          font-weight: 600;
        `;
      });
      
      table.querySelectorAll('td').forEach(td => {
        td.style.cssText = `
          border: 1px solid #e0e5ea;
          padding: 10px 8px;
          text-align: left;
        `;
      });
    });
    
    // Add to body temporarily for PDF generation
    document.body.appendChild(tempDiv);
    
    // Configure PDF options
    const opt = {
      margin: 0.5,
      filename: doc.name.replace(/\.[^/.]+$/, '') + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    
    // Generate and download PDF
    try {
      await html2pdf().set(opt).from(tempDiv).save();
      console.log(`PDF download completed: ${doc.name}`);
    } finally {
      // Clean up - remove the temporary div
      document.body.removeChild(tempDiv);
    }
    
  } catch (error) {
    console.error('Download document error:', error);
    alert(`Failed to download document: ${error.message}`);
  }
}

// Delete Functions
let documentToDelete = null;

function deleteDocument(id) {
  const doc = documentsData.find(d => d.id === id);
  if (!doc) {
    alert('Document not found');
    return;
  }
  
  documentToDelete = doc;
  
  // Update the modal with document info
  document.getElementById('deleteDocumentName').textContent = doc.name;
  
  // Reset checkbox and button state
  const checkbox = document.getElementById('deleteConfirmCheck');
  const deleteBtn = document.getElementById('confirmDelete');
  checkbox.checked = false;
  deleteBtn.disabled = true;
  
  // Show the modal
  document.getElementById('deleteModal').showModal();
}

async function confirmDocumentDelete() {
  if (!documentToDelete) return;
  
  try {
    console.log(`Deleting document: ${documentToDelete.vertesiaId}`);
    
    // Make DELETE request to Vertesia API
    const response = await fetch(`https://api.vertesia.io/api/v1/objects/${documentToDelete.vertesiaId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
      }
    });
    
    if (!response.ok) {
      throw new Error(`Failed to delete document: ${response.status}`);
    }
    
    const result = await response.json();
    console.log('Delete result:', result);
    
    // Remove from local array
    documentsData = documentsData.filter(d => d.id !== documentToDelete.id);
    
    // Re-render the document list and update profile status
    renderDocuments();
    updateProfileStatus();
    
    // Close modal and reset
    document.getElementById('deleteModal').close();
    documentToDelete = null;
    
    console.log(`Document deleted successfully`);
    
  } catch (error) {
    console.error('Delete document error:', error);
    alert(`Failed to delete document: ${error.message}`);
  }
}

function cancelDocumentDelete() {
  document.getElementById('deleteModal').close();
  documentToDelete = null;
}

// Initialize on page load
window.onload = init;
</script>

</body>
</html>
